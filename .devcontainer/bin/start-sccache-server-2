#! /usr/bin/env bash

# Ensure we're in the repo root
cd "$( cd "$( dirname "$(realpath -m "${BASH_SOURCE[0]}")" )" && pwd )/../..";
cd "${SCCACHE_REPO:-$(pwd)}";

if ! command -v sccache-dist >/dev/null 2>&1; then
    export PATH="$(realpath -m "$(pwd)/target/$(uname -m)-unknown-linux-musl/${BUILD_TYPE:-debug}"):$PATH"
fi

ulimit -n "$(ulimit -Hn)"
sudo rm -rf /tmp/sccache/server-2
sudo mkdir -p /tmp/sccache/server-2

sudo --preserve-env=AWS_ACCESS_KEY_ID,AWS_SECRET_ACCESS_KEY \
    RUST_BACKTRACE="${RUST_BACKTRACE:-1}" \
    SCCACHE_NO_DAEMON=1 \
    SCCACHE_DIST_OS=linux \
    SCCACHE_DIST_ARCH="$(dpkg --print-architecture)" \
    SCCACHE_DIST_BUILDER_TYPE="${SCCACHE_REPO:+"docker"}" \
    SCCACHE_LOG="celery=warn,sccache=${SCCACHE_LOG:-info}" \
    "$(which sccache-dist)" server --config .devcontainer/.config/sccache/server2.conf
